<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Responsive Stream Player</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.6.12/dist/plyr.css" />

  <style>
    :root{
      --bg:#000;
      --control-size: 44px;
    }
    html,body{
      height:100%;
      width:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      user-select: none;
    }

    /* full-viewport fixed container so player always fills screen and works with orientation changes */
    .player-wrap {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg);
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
      overflow:hidden;
      touch-action: manipulation;
    }

    .video-container {
      width:100%;
      height:100%;
      max-width:100%;
      max-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    video#player {
      width:100%;
      height:100%;
      max-width:100%;
      max-height:100%;
      object-fit: contain; /* change to cover if you prefer fullscreen crop */
      background:#000;
      border:0;
      display:block;
    }

    .plyr {
      width:100%;
      height:100%;
      display:block;
    }

    /* spinner centered and responsive */
    .spinner {
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      color:#fff;
      font-family: Arial, sans-serif;
      font-size:14px;
      background:rgba(0,0,0,0.5);
      padding:8px 12px;
      border-radius:8px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:40;
      pointer-events:none;
    }

    @media (max-width:520px){
      :root{ --control-size: 40px; }
      .spinner { font-size:13px; padding:6px 10px; }
    }
    @media (min-width:1200px){
      :root{ --control-size: 56px; }
      .spinner { font-size:15px; padding:10px 14px; }
    }

    .plyr .plyr__controls {
      gap:8px;
    }
    .plyr .plyr__controls button, .plyr .plyr__controls [data-plyr="play"] {
      min-width: var(--control-size);
      min-height: var(--control-size);
    }

    /* ensure the auto-hide class transitions smoothly */
    .plyr--hide-controls .plyr__controls {
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease-in-out;
    }
    .plyr__controls {
      transition: opacity .25s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="player-wrap" id="playerWrap">
    <div class="video-container">
      <video id="player" autoplay muted playsinline preload="auto" crossorigin></video>
      <div id="spinner" class="spinner" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 50 50" aria-hidden="true">
          <circle cx="25" cy="25" r="20" fill="none" stroke="white" stroke-width="4" stroke-opacity="0.15"></circle>
          <path d="M45 25a20 20 0 0 0-4-11" stroke="white" stroke-width="4" stroke-linecap="round" fill="none"/>
        </svg>
        <span id="spinnerText">Connecting…</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.1.4/dist/hls.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.6.12/dist/plyr.min.js"></script>

  <script>
  (function(){
    // ========== CONFIG ==========
    const source = "https://golu.allinonereborn.fun/hls_cors.php?key=mukesh";
    const video = document.getElementById('player');
    const spinner = document.getElementById('spinner');
    const spinnerText = document.getElementById('spinnerText');
    const playerWrap = document.getElementById('playerWrap');

    // instantiate Plyr early so UI exists immediately
    const plyrPlayer = new Plyr(video, {
      controls: ['play-large','play','mute','volume','settings','airplay','fullscreen','pip'],
      hideControls: true,
      clickToPlay: true,
      inactivityTimeout: 3000, // 3 seconds
      keyboard: { global: true }
    });

    function showSpinner(text){
      if(spinner){ spinner.style.display = 'flex'; spinnerText.textContent = text || 'Connecting…'; }
    }
    function hideSpinner(){ if(spinner) spinner.style.display = 'none'; }

    // Helper: force-show controls by removing plyr's hide-class
    function forceShowControls() {
      try {
        const c = plyrPlayer && plyrPlayer.elements && plyrPlayer.elements.container;
        if (c) c.classList.remove('plyr--hide-controls');
      } catch(e){}
    }
    // Helper: let Plyr auto-hide again by not interfering. We'll call forceShowControls on interaction.
    function scheduleAutoHideReset() {
      // Plyr will auto hide after inactivityTimeout; we just ensure class removed when user interacts
      // and allow Plyr to reapply hide class automatically.
      // nothing else needed here
    }

    // show spinner initially
    showSpinner('Loading manifest…');

    // Responsive: on resize/orientation we can hint hls to cap level to player size
    function onResize() {
      try {
        if (window.hlsInstance && window.hlsInstance.config && window.hlsInstance.levels) {
          // optional: cap levels to player size if supported - not forcing anything here
        }
      } catch (e) {}
    }
    window.addEventListener('resize', onResize, {passive:true});
    window.addEventListener('orientationchange', onResize, {passive:true});

    // HLS playback with hls.js for browsers (fast startup tuning)
    if (Hls.isSupported()) {
      const hls = new Hls({
        enableWorker: true,
        lowLatencyMode: true,
        startLevel: -1,
        maxBufferLength: 8,
        backBufferLength: 30,
        capLevelToPlayerSize: true,
        liveSyncDurationCount: 3,
        manifestLoadingTimeOut: 8000,
        levelLoadingTimeOut: 8000,
        fragLoadingTimeOut: 10000
      });
      // expose for optional debugging/resizing
      window.hlsInstance = hls;

      hls.on(Hls.Events.MANIFEST_LOADING, () => showSpinner('Loading manifest…'));
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        // try play; muted autoplay usually allowed
        video.play().catch(()=>{});
      });

      // hide spinner when fragments begin arriving / first frame ready
      hls.on(Hls.Events.FRAG_LOADED, () => hideSpinner());
      hls.on(Hls.Events.FRAG_PARSING_INIT_SEGMENT, () => hideSpinner());
      video.addEventListener('playing', hideSpinner);

      hls.on(Hls.Events.ERROR, function(event, data) {
        console.warn('hls error', data);
        if (data && data.fatal) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              showSpinner('Network error — retrying…');
              hls.startLoad();
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              showSpinner('Media error — recovering…');
              hls.recoverMediaError();
              break;
            default:
              showSpinner('Stream error — reloading…');
              setTimeout(()=>{ hls.destroy(); location.reload(); }, 1200);
              break;
          }
        }
      });

      hls.loadSource(source);
      hls.attachMedia(video);

    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Native HLS (Safari)
      showSpinner('Starting native HLS…');
      video.src = source;
      video.addEventListener('loadedmetadata', () => {
        hideSpinner();
        video.play().catch(()=>{});
      });
    } else {
      document.body.innerHTML = '<p style="color:white;text-align:center;margin-top:20%">Your browser does not support HLS playback.</p>';
    }

    // Ensure spinner removed if video plays
    video.addEventListener('playing', hideSpinner);
    video.addEventListener('error', () => showSpinner('Playback error — check source'));

    // --- Improve control show/hide responsiveness ---
    // On user interaction (mouse move, touch), ensure controls appear immediately.
    let interactionTimer = null;
    function onUserInteraction(e) {
      // show controls immediately
      forceShowControls();

      // clear any pending timer
      if (interactionTimer) clearTimeout(interactionTimer);

      // After inactivity timeout, allow Plyr to hide controls again (Plyr manages it internally).
      // We'll schedule a small task to re-add hide-class if user left, but default Plyr will handle it.
      interactionTimer = setTimeout(() => {
        // Let Plyr apply its own hide class — do nothing here.
      }, 3500); // slightly longer than inactivityTimeout to ensure one last visible moment
    }

    // listen on the wrapper for pointer/mouse/touch
    ['mousemove','mousedown','touchstart','touchmove','touchend','pointermove'].forEach(evt => {
      playerWrap.addEventListener(evt, onUserInteraction, {passive:true});
    });

    // Also show controls when keyboard used (space/play)
    document.addEventListener('keydown', forceShowControls, {passive:true});

    // try autoplay again soon if still paused (some browsers delay autoplay)
    setTimeout(()=>{ if (video.paused) video.play().catch(()=>{}); }, 700);

  })();
  </script>
</body>
</html>
